<script>
  const savedUser = localStorage.getItem('username');
  const loginContainer = document.getElementById('login-container');
  const chatContainer = document.getElementById('chat-container');
  const loginForm = document.getElementById('login-form');
  const usernameInput = document.getElementById('username');

  let username = '';

  if (savedUser) {
    username = savedUser;
    loginContainer.style.display = 'none';
    chatContainer.style.display = 'flex';
  }

  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    username = usernameInput.value.trim();
    if (username) {
      localStorage.setItem('username', username);
      loginContainer.style.display = 'none';
      chatContainer.style.display = 'flex';
    }
  });

  const socket = io();
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  const messages = document.getElementById('messages');

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    if (input.value) {
      const message = { user: username, text: input.value };
      socket.emit('chat message', message);
      input.value = '';
    }
  });

  socket.on('chat message', function (msg) {
    const item = document.createElement('li');
    item.className = 'message';
    if (msg.user === username) item.classList.add('own');
    item.innerHTML = `
      <div><strong>${msg.user}</strong></div>
      <div>${msg.text}</div>
      <div class="checkmarks">
        ${msg.delivered ? '✔' : ''} ${msg.read ? '✔' : ''}
      </div>
    `;
    messages.appendChild(item);
    messages.scrollTop = messages.scrollHeight;

    // Emit 'message delivered' event when the message is displayed
    socket.emit('message delivered', msg);
  });

  socket.on('update message', function (msg) {
    const messageElements = document.querySelectorAll('.message');
    messageElements.forEach((element) => {
      const messageText = element.querySelector('div:nth-child(2)').textContent;
      if (messageText === msg.text) {
        const checkmarks = element.querySelector('.checkmarks');
        checkmarks.innerHTML = `
          ${msg.delivered ? '✔' : ''} ${msg.read ? '✔' : ''}
        `;
      }
    });
  });

  // To simulate message reading after some time
  setInterval(() => {
    // Check if message is read (for demo purposes, we mark all messages read)
    const unreadMessages = document.querySelectorAll('.message:not(.own) .checkmarks');
    unreadMessages.forEach((checkmark) => {
      if (!checkmark.innerHTML.includes('✔')) {
        socket.emit('message read', { user: username, text: checkmark.parentElement.querySelector('div:nth-child(2)').textContent });
      }
    });
  }, 5000);
</script>
